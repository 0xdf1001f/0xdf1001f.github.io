<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Ramsay | Wei's Blog</title><meta name="description" content="新浪突然不支持外链，图基本挂没了，但是我这个铁懒狗不想一张一张再上传了"><meta name="keywords" content="恶意软件"><meta name="author" content="Yenn_"><meta name="copyright" content="Yenn_"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Ramsay"><meta name="twitter:description" content="新浪突然不支持外链，图基本挂没了，但是我这个铁懒狗不想一张一张再上传了"><meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006o5z8lgy1gcutqxg6juj309w03x0st.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Ramsay"><meta property="og:url" content="https://0xdf1001f.github.io/2020/06/06/Ramsay/"><meta property="og:site_name" content="Wei's Blog"><meta property="og:description" content="新浪突然不支持外链，图基本挂没了，但是我这个铁懒狗不想一张一张再上传了"><meta property="og:image" content="http://ww1.sinaimg.cn/large/006o5z8lgy1gcutqxg6juj309w03x0st.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '2'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://0xdf1001f.github.io/2020/06/06/Ramsay/"><link rel="prev" title="HW中的一枚CS马" href="https://0xdf1001f.github.io/2020/09/19/HW%E4%B8%AD%E7%9A%84%E4%B8%80%E6%9E%9ACS%E9%A9%AC/"><link rel="next" title="e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0" href="https://0xdf1001f.github.io/2020/06/06/e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Wei's Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Ramsay"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Ramsay</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#基本信息"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">基本信息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#简介"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">简介</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#动态行为"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">动态行为</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#分析"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">分析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#查壳"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">查壳</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#读取自身"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">读取自身</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#判断权限级别"><span class="toc_mobile_items-number">1.4.3.</span> <span class="toc_mobile_items-text">判断权限级别</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#释放并执行多个exe文件"><span class="toc_mobile_items-number">1.4.4.</span> <span class="toc_mobile_items-text">释放并执行多个exe文件</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#moprxlpbpm-exe"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">moprxlpbpm.exe</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#反调试"><span class="toc_mobile_items-number">1.5.1.</span> <span class="toc_mobile_items-text">反调试</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#kfzagiqcbu-exe"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">kfzagiqcbu.exe</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#释放文件执行"><span class="toc_mobile_items-number">1.6.1.</span> <span class="toc_mobile_items-text">释放文件执行</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#释放文件，驱动执行"><span class="toc_mobile_items-number">1.6.2.</span> <span class="toc_mobile_items-text">释放文件，驱动执行</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#释放msfte-Dll，劫持服务自启"><span class="toc_mobile_items-number">1.6.3.</span> <span class="toc_mobile_items-text">释放msfte.Dll，劫持服务自启</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#拷贝自身"><span class="toc_mobile_items-number">1.6.4.</span> <span class="toc_mobile_items-text">拷贝自身</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#释放oci-Dll，劫持服务自启"><span class="toc_mobile_items-number">1.6.5.</span> <span class="toc_mobile_items-text">释放oci.Dll，劫持服务自启</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#删除自身"><span class="toc_mobile_items-number">1.6.6.</span> <span class="toc_mobile_items-text">删除自身</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#bindsvc-exe"><span class="toc_mobile_items-number">1.7.</span> <span class="toc_mobile_items-text">bindsvc.exe</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Hfile-sys"><span class="toc_mobile_items-number">1.8.</span> <span class="toc_mobile_items-text">Hfile.sys</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#msfte-dll、oci-dll"><span class="toc_mobile_items-number">1.9.</span> <span class="toc_mobile_items-text">msfte.dll、oci.dll</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#当进程为SearchIndexer-exe时"><span class="toc_mobile_items-number">1.9.1.</span> <span class="toc_mobile_items-text">当进程为SearchIndexer.exe时</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#当进程为explorer-exe时"><span class="toc_mobile_items-number">1.9.2.</span> <span class="toc_mobile_items-text">当进程为explorer.exe时</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#当进程为msdtc-exe时"><span class="toc_mobile_items-number">1.9.3.</span> <span class="toc_mobile_items-text">当进程为msdtc.exe时</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#当进程为HTON-exe、BON-exe、Cover-exe时"><span class="toc_mobile_items-number">1.9.4.</span> <span class="toc_mobile_items-text">当进程为HTON.exe、BON.exe、Cover.exe时</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#总结"><span class="toc_mobile_items-number">1.10.</span> <span class="toc_mobile_items-text">总结</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ramsay"><span class="toc-number">1.</span> <span class="toc-text">Ramsay</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本信息"><span class="toc-number">1.1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态行为"><span class="toc-number">1.3.</span> <span class="toc-text">动态行为</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析"><span class="toc-number">1.4.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查壳"><span class="toc-number">1.4.1.</span> <span class="toc-text">查壳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读取自身"><span class="toc-number">1.4.2.</span> <span class="toc-text">读取自身</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#判断权限级别"><span class="toc-number">1.4.3.</span> <span class="toc-text">判断权限级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#释放并执行多个exe文件"><span class="toc-number">1.4.4.</span> <span class="toc-text">释放并执行多个exe文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#moprxlpbpm-exe"><span class="toc-number">1.5.</span> <span class="toc-text">moprxlpbpm.exe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#反调试"><span class="toc-number">1.5.1.</span> <span class="toc-text">反调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kfzagiqcbu-exe"><span class="toc-number">1.6.</span> <span class="toc-text">kfzagiqcbu.exe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#释放文件执行"><span class="toc-number">1.6.1.</span> <span class="toc-text">释放文件执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#释放文件，驱动执行"><span class="toc-number">1.6.2.</span> <span class="toc-text">释放文件，驱动执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#释放msfte-Dll，劫持服务自启"><span class="toc-number">1.6.3.</span> <span class="toc-text">释放msfte.Dll，劫持服务自启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拷贝自身"><span class="toc-number">1.6.4.</span> <span class="toc-text">拷贝自身</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#释放oci-Dll，劫持服务自启"><span class="toc-number">1.6.5.</span> <span class="toc-text">释放oci.Dll，劫持服务自启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除自身"><span class="toc-number">1.6.6.</span> <span class="toc-text">删除自身</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bindsvc-exe"><span class="toc-number">1.7.</span> <span class="toc-text">bindsvc.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hfile-sys"><span class="toc-number">1.8.</span> <span class="toc-text">Hfile.sys</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msfte-dll、oci-dll"><span class="toc-number">1.9.</span> <span class="toc-text">msfte.dll、oci.dll</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#当进程为SearchIndexer-exe时"><span class="toc-number">1.9.1.</span> <span class="toc-text">当进程为SearchIndexer.exe时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当进程为explorer-exe时"><span class="toc-number">1.9.2.</span> <span class="toc-text">当进程为explorer.exe时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当进程为msdtc-exe时"><span class="toc-number">1.9.3.</span> <span class="toc-text">当进程为msdtc.exe时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当进程为HTON-exe、BON-exe、Cover-exe时"><span class="toc-number">1.9.4.</span> <span class="toc-text">当进程为HTON.exe、BON.exe、Cover.exe时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.10.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(http://ww1.sinaimg.cn/large/006o5z8lgy1gcutqxg6juj309w03x0st.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">Ramsay</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-06-06<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-11-13</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Windows/">Windows</a><i class="fa fa-angle-right fa-fw" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Windows/%E6%A0%B7%E6%9C%AC/">样本</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.3k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 11 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Ramsay"><a href="#Ramsay" class="headerlink" title="Ramsay"></a>Ramsay</h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><table>
<thead>
<tr>
<th>File Nmae</th>
<th>File Size</th>
<th>File Type</th>
<th>MD5</th>
</tr>
</thead>
<tbody><tr>
<td>Ramsa1Exe.exe</td>
<td>1,849,905 Byte</td>
<td>Spy</td>
<td>186b2e42de0d2e58d070313bd6730243</td>
</tr>
</tbody></table>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>样本通过感染内网中的exe程序，进而感染word文档，随着Word文档由U盘带入隔离网，感染隔离网的文件并在隔离网内持久化，搜集情报，打包成加密的rar文件，并将rar文档二次加密后附加在word文档尾部，再跟随word文档由U盘带出隔离网，病毒判断每一次Word文档附加的指令，执行不同的代码</p>
<h2 id="动态行为"><a href="#动态行为" class="headerlink" title="动态行为"></a>动态行为</h2><p>样本是一个7-Zip安装包，点击运行后释放多个文件并创建了大量进程，其中包含有正常安装7-Zip部分的进程</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106112820.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106112820.png" class="lazyload"></a></p>
<p>调用CMD查询计算机信息、网络、查询端口等</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106112907.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106112907.png" class="lazyload"></a></p>
<p>在多个目录下释放大量文件</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h3><p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106112943.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106112943.png" class="lazyload"></a></p>
<p>无壳，样本是一个NSIS打包成的7-Zip压缩包</p>
<h3 id="读取自身"><a href="#读取自身" class="headerlink" title="读取自身"></a>读取自身</h3><p>载入OD与IDA中，经过入口点初始化之后，样本会在执行正常安装程序之前先执行恶意代码</p>
<p>申请内存，将自身读取到申请的内存中</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113158.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113158.png" class="lazyload"></a></p>
<h3 id="判断权限级别"><a href="#判断权限级别" class="headerlink" title="判断权限级别"></a>判断权限级别</h3><p>通过获取SID结构，判断当前进程权限，执行不同的代码</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfdwihld1hj30nm06lwf0.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfdwihld1hj30nm06lwf0.jpg" class="lazyload"></a></p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113323.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113323.png" class="lazyload"></a></p>
<h3 id="释放并执行多个exe文件"><a href="#释放并执行多个exe文件" class="headerlink" title="释放并执行多个exe文件"></a>释放并执行多个exe文件</h3><p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113346.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113346.png" class="lazyload"></a></p>
<p>获取%Temp%目录，再拼接出路径</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113359.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113359.png" class="lazyload"></a></p>
<p>判断%Temp%目录下是否已经存在要释放出的随机字符串.exe文件</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113642.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113642.png" class="lazyload"></a></p>
<p>拼接出特定字符串“pN64RaafaQfjWXjM3Ku3UkqP”,在最开始将自身读取到申请的内存空间中比较，</p>
<p>匹配上这一段字符串</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113703.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113703.png" class="lazyload"></a></p>
<p>匹配</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113721.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113721.png" class="lazyload"></a></p>
<p>在内存中比较到字符串，可以发现字符串后面跟着的就是一个PE文件</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113735.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113735.png" class="lazyload"></a></p>
<p>后面同样，拼接出另一个字符串，然后再内存中寻找匹配</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113751.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113751.png" class="lazyload"></a></p>
<p>申请内存，拷贝第一次匹配到的PE文件到申请的内存中</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113856.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113856.png" class="lazyload"></a></p>
<p>将拷贝的PE文件写入到前面拼接的%TEMP%下的随机字符串.exe中</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113952.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106113952.png" class="lazyload"></a></p>
<p>修改释放出的exe文件的创建时间、修改时间、访问时间</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114006.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114006.png" class="lazyload"></a></p>
<p>用同样的方法，拼接出另两个字符串”4znZCTTa2J24E64GzUxaUnYg”和”2A2rRhArF6akS9PaRZBwdrbn”，在内存中匹配然后将PE文件写到%TEMP%目录下另一个exe中</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114026.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114026.png" class="lazyload"></a></p>
<p>调用ShellExecuteExW执行刚才释放出的第二个PE文件</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114051.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114051.png" class="lazyload"></a></p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114106.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114106.png" class="lazyload"></a></p>
<p>判断在C:\Windows\System32目录下是否存在msfte.dll，如果不存在且权限够高的话，则再次从生成随机字符串</p>
<p>利用和前面一样的方法，在内存中匹配字符串”2A2rRhArF6akS9PaRZBwdrbn”和”pN64RaafaQfjWXjM3Ku3UkqP”</p>
<p>得出PE文件</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114133.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114133.png" class="lazyload"></a></p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114148.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114148.png" class="lazyload"></a></p>
<p>调用CreateProcess执行刚释放出的exe</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114207.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114207.png" class="lazyload"></a></p>
<p>到这里代码就执行完了，后面的是正常安装7-Zip的代码</p>
<h2 id="moprxlpbpm-exe"><a href="#moprxlpbpm-exe" class="headerlink" title="moprxlpbpm.exe"></a>moprxlpbpm.exe</h2><p>moprxlpbpm.exe是被母体释放出的第二个exe文件，在前面通过ShellExecuteExW执行</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114354.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114354.png" class="lazyload"></a></p>
<h3 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h3><p>样本Winmain开头检测CommandLine，如果不是从母体调用而是双击运行会直接退出程序</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114438.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114438.png" class="lazyload"></a></p>
<p>用第一次释放的PE文件CopyFile覆盖病毒母体</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe13oh5buj30p5019jr7.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe13oh5buj30p5019jr7.jpg" class="lazyload"></a></p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114455.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114455.png" class="lazyload"></a></p>
<p>覆盖之后</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe15aw7efj30hd020mx6.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe15aw7efj30hd020mx6.jpg" class="lazyload"></a></p>
<p>然后调用ShellExecuteExW运行病毒母体，实际上是第一次释放出的PE文件</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114529.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114529.png" class="lazyload"></a></p>
<p>这个是正常的7-z安装器</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114544.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114544.png" class="lazyload"></a></p>
<p>运行后删除第一次释放出的PE文件</p>
<p><a href="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114556.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106114556.png" class="lazyload"></a></p>
<h2 id="kfzagiqcbu-exe"><a href="#kfzagiqcbu-exe" class="headerlink" title="kfzagiqcbu.exe"></a>kfzagiqcbu.exe</h2><p>kfzagiqcbu.exe是第三次释放出的PE文件，Dropper，负责释放其他文件</p>
<p>查壳后UPX的壳，脱掉后</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe1pb3yhfj30bo06g0t6.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe1pb3yhfj30bo06g0t6.jpg" class="lazyload"></a></p>
<h3 id="释放文件执行"><a href="#释放文件执行" class="headerlink" title="释放文件执行"></a>释放文件执行</h3><p>先检查路径C:\Users\sam\AppData\Roaming\Microsoft\UserSetting是否存在，不存在则创建</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe5qz4tsgj30my01haa4.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe5qz4tsgj30my01haa4.jpg" class="lazyload"></a></p>
<p>判断程序的CommandLine是否有字符串”gQ9VOe5m8zP6”，执行不同的代码</p>
<p>判断C:\Windows\system32\msfte.dll是否存在，执行不同的代码</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe5wyn9e5j30i702swel.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe5wyn9e5j30i702swel.jpg" class="lazyload"></a></p>
<p>判断文件夹C:\Windows\System32\Identities是否存在，不存在就创建并设置属性为隐藏</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe65tnlz8j30jk05z0t6.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe65tnlz8j30jk05z0t6.jpg" class="lazyload"></a></p>
<p>并将自身拷贝到C:\Windows\System32\Identities\下并命名为wideshut.exe</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe69cuwnwj30ln07g0tf.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe69cuwnwj30ln07g0tf.jpg" class="lazyload"></a></p>
<p>写入另一个PE文件到C:\Windows\System32\Identities\Sharp.exe</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe6g8k8olj30qs03fdg0.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe6g8k8olj30qs03fdg0.jpg" class="lazyload"></a></p>
<p>拼接另一个路径并写入文件bindsvc.exe，再调用CreateProcessW执行</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe6jiex2vj30m204vdg9.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfe6jiex2vj30m204vdg9.jpg" class="lazyload"></a></p>
<h3 id="释放文件，驱动执行"><a href="#释放文件，驱动执行" class="headerlink" title="释放文件，驱动执行"></a>释放文件，驱动执行</h3><p>执行bindsvc.exe后，利用函数iswow64process判断当前系统是32位或是64位，当系统为32位时，判断C:\Windows\System32\Drivers\hfile.sys是否存在，如果存在就把它移动到%temp%目录下随机字符串.dat</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfetub2ey2j30no08swfd.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfetub2ey2j30no08swfd.jpg" class="lazyload"></a></p>
<p>不论是否存在C:\Windows\System32\Drivers\hfile.sys，都会createfile，然后写入内容</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfetw1oofnj30od07nweo.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfetw1oofnj30od07nweo.jpg" class="lazyload"></a></p>
<p>当C:\Windows\System32\Drivers\hfile.sys已经存在且被移动到%temp%下之后，会用hfile.sys创建一个驱动并启动，设置为开机自动启动服务</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuezwto2j30jk0ftdgs.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuezwto2j30jk0ftdgs.jpg" class="lazyload"></a></p>
<p>已经运行的驱动</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeufidy56j30gk00umx1.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeufidy56j30gk00umx1.jpg" class="lazyload"></a></p>
<p>运行后，样本会尝试连接\.\HideDriver并尝试使用DeviceIOControl传输buffer</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeura8kswj30hr05xjru.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeura8kswj30hr05xjru.jpg" class="lazyload"></a></p>
<h3 id="释放msfte-Dll，劫持服务自启"><a href="#释放msfte-Dll，劫持服务自启" class="headerlink" title="释放msfte.Dll，劫持服务自启"></a>释放msfte.Dll，劫持服务自启</h3><p>判断C:\Windows\System32\msfte.dll是否存在，还是和前面一样，存在就移动到%TEMP%下随机名.dat，然后再新写入一个msfte.dll</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuwhpy19j30he04udg4.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuwhpy19j30he04udg4.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuw5jpetj30o207kq34.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuw5jpetj30o207kq34.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuyk13cfj309x0d274r.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfeuyk13cfj309x0d274r.jpg" class="lazyload"></a></p>
<p>劫持Windows的服务Windows Search，修改为开机自启，因为Wsearch服务开加载msfte.dll，所以样本也能跟随服务实现开机自启</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfevw7gahtj30bn0c5t9j.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfevw7gahtj30bn0c5t9j.jpg" class="lazyload"></a></p>
<p>查询C:\Windows\System32\oci.dll是否存在，存在就移动到%TEMP%下随机名.exe，再写入一个C:\Windows\System32\oci.dll</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewi5rcc4j30qh05bgm1.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewi5rcc4j30qh05bgm1.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewijh8exj30af0d5dge.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewijh8exj30af0d5dge.jpg" class="lazyload"></a></p>
<h3 id="拷贝自身"><a href="#拷贝自身" class="headerlink" title="拷贝自身"></a>拷贝自身</h3><p>判断C:\Windows\System32\wimsvc.exe是否存在，存在则复制到%TEMP%目录下的随机名.exe</p>
<p>然后将样本自身拷贝到C:\Windows\System32\wimsvc.exe</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewmwek7oj30ku07xaas.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewmwek7oj30ku07xaas.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewqwhd64j30he0cyt9j.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewqwhd64j30he0cyt9j.jpg" class="lazyload"></a></p>
<h3 id="释放oci-Dll，劫持服务自启"><a href="#释放oci-Dll，劫持服务自启" class="headerlink" title="释放oci.Dll，劫持服务自启"></a>释放oci.Dll，劫持服务自启</h3><p>利用同样的方法，修改服务“MSDTC”为自启动，使前面释放的oci.dll跟随服务自动</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewvfv1l0j30o90820td.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfewvfv1l0j30o90820td.jpg" class="lazyload"></a></p>
<p>调用CMD，拼接参数，修改”MSDTC”的ObjectName=”LocalSystem”</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfex6u3bblj30md04574m.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfex6u3bblj30md04574m.jpg" class="lazyload"></a></p>
<h3 id="删除自身"><a href="#删除自身" class="headerlink" title="删除自身"></a>删除自身</h3><p>在%temp%目录下创建一个.bat文件，多次拼接，删除样本自身和bat文件自身</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfexh5v20ij30te0cptam.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfexh5v20ij30te0cptam.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfexhh7hgrj30g50660tj.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfexhh7hgrj30g50660tj.jpg" class="lazyload"></a></p>
<p>kfzagiqcbu.exe的代码到这里结束</p>
<h2 id="bindsvc-exe"><a href="#bindsvc-exe" class="headerlink" title="bindsvc.exe"></a>bindsvc.exe</h2><p>Bindsvc.exe是由Dropper执行的第一个文件</p>
<p>查壳</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff17s9im3j30bu06tjrz.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff17s9im3j30bu06tjrz.jpg" class="lazyload"></a></p>
<p>查询注册表HKEY_CURRENT_USER\Volatile Environment下APPDATA和LOCALAPPDATA环境变量的路径</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1bna8d7j30k80avq3b.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1bna8d7j30k80avq3b.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1c7pm7gj30hu02eq2w.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1c7pm7gj30hu02eq2w.jpg" class="lazyload"></a></p>
<p>查询C:\Users\sam\AppData\Roaming\Microsoft\UserSetting是否存在，不存在则创建，这个路径被隐藏了，估计是驱动隐藏的</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1j0galhj30lq03et8y.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1j0galhj30lq03et8y.jpg" class="lazyload"></a></p>
<p>读取文件C:\Windows\System32\Identities\wideshut.exe，同样这个路径已经被隐藏了，当这个文件不存在的时候有一串提示语“Ramsay is not exist. I will finish.”</p>
<p>拼接出五串字符串，读取后通过几组字符串读取数据</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1u6jdigj30mt05aq3m.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff1u6jdigj30mt05aq3m.jpg" class="lazyload"></a></p>
<p>读取自身到申请的一块空间中，然后通过前面拼接的第二组和第三组字符串读取数据，第一次读取病毒的StartKit</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff23fcg3nj30oh01zwej.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff23fcg3nj30oh01zwej.jpg" class="lazyload"></a></p>
<p>通过第一组和第二组读取TrnCleaner</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff2aooxgvj30ky05l3yt.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff2aooxgvj30ky05l3yt.jpg" class="lazyload"></a></p>
<p>判断文件C:\Users\sam\AppData\Roaming\Microsoft\UserSetting\trnmg.sdb是否存在，存在就删除，这个文件是病毒的日志,加密后存储，这个路径也被hfile.sys隐藏，设置有守护线程一直设置隐藏，卸载掉驱动再取消隐藏、系统属性就可以看见</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff2fqhdhzj30mo02at8s.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff2fqhdhzj30mo02at8s.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff332nc4gj30gd02fq30.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff332nc4gj30gd02fq30.jpg" class="lazyload"></a></p>
<p>获取系统所有盘符，排除A、B软盘，递归遍历除了系统盘之外的所有盘符</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff484zz0aj30gz077jrr.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff484zz0aj30gz077jrr.jpg" class="lazyload"></a></p>
<p>读取到EXE文件后，只感染文件小于256MB的文件，通过判断字符串</p>
<p>“9J7uQTqgTxhqHaGUue5caaEr3KU”和”9J7uQTqgTxhqHaGUue5caaEr”判断文件是否被感染</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff4uat9uuj30sy0eswg0.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff4uat9uuj30sy0eswg0.jpg" class="lazyload"></a></p>
<p>创建文件夹C:\Users\sam\AppData\Local\Temp{e91461b4-a519-4110-9fae-d2895719dbb1},并设置为隐藏属性</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff52qkelej30nr06bdgd.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff52qkelej30nr06bdgd.jpg" class="lazyload"></a></p>
<p>在新建的文件夹下创建一个同名exe,将前面获取的StartKit写入，通过比较，只有文件尾部的零填充字节多少不同，其他部分一致</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff603lp5yj30ly06idfu.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff603lp5yj30ly06idfu.jpg" class="lazyload"></a></p>
<p>更新资源，修改代码，将exe感染成为与7z安装器相同的结构</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff6yd7stwj30kv0590ta.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff6yd7stwj30kv0590ta.jpg" class="lazyload"></a></p>
<p>完成后，将被感染的exe覆盖原来的exe文件，并删除新建的exe文件，将被感染文件的时间修改为前面获取到的正常exe的时间</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff748wqhej30k90abt9p.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff748wqhej30k90abt9p.jpg" class="lazyload"></a></p>
<p>感染exe后的日志解密后</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gff7rf8dgkj30m508hgmb.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gff7rf8dgkj30m508hgmb.jpg" class="lazyload"></a></p>
<p>获取计算机网卡信息并写入到日志中</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg1hmitmij30or0c9q42.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg1hmitmij30or0c9q42.jpg" class="lazyload"></a></p>
<p>创建新线程，感染网络中共享磁盘</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg3a54qrmj30iy06udgd.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg3a54qrmj30iy06udgd.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg3bcbep1j30ii04d0sz.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg3bcbep1j30ii04d0sz.jpg" class="lazyload"></a></p>
<p>bindsvc.exe的代码到这里结束</p>
<h2 id="Hfile-sys"><a href="#Hfile-sys" class="headerlink" title="Hfile.sys"></a>Hfile.sys</h2><p>Hfile.sys是Dropper释放出的驱动文件，载入IDA后会提示有PDB路径，路径为</p>
<p>C:\users\vmware\desktop\hidedriver\bin\Release\i386\HideDriver.pdb</p>
<p>这个文件是一个Rootkit，用来隐藏创建的各种文件和文件夹，不卸载掉Hfile.sys这驱动，在RING3下对文件夹去除隐藏操作无效的</p>
<h2 id="msfte-dll、oci-dll"><a href="#msfte-dll、oci-dll" class="headerlink" title="msfte.dll、oci.dll"></a>msfte.dll、oci.dll</h2><p>msfte.dll、oci.dll两个文件基本一致，只有一个字节差别</p>
<p>msfte.dll是Dropper释放出劫持服务”Windows Search”的文件，跟随服务“Windows Search”的自启而被加载实现自启</p>
<p>无壳</p>
<p><a href="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1591241586760.png" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1591241586760.png" class="lazyload"></a></p>
<p>创建文件夹C:\Users\sam\AppData\Roaming\Microsoft\UserSetting，获取系统硬件配置文件全局标识符GUID</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg6wmv8dtj30n503rdg7.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg6wmv8dtj30n503rdg7.jpg" class="lazyload"></a></p>
<p>查询当前加载该DLL的程序，并判断是SearchIndexer.exe、explorer.exe、msdtc.exe，执行不同代码</p>
<h3 id="当进程为SearchIndexer-exe时"><a href="#当进程为SearchIndexer-exe时" class="headerlink" title="当进程为SearchIndexer.exe时"></a>当进程为SearchIndexer.exe时</h3><p>一个死循环新线程，创建一个和explorer.exe同样TOKEN的SearchProtocolHost.exe，然后程序结束</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg7gni3rij30nx04ower.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg7gni3rij30nx04ower.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg7k37f05j30fi078jri.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg7k37f05j30fi078jri.jpg" class="lazyload"></a></p>
<h3 id="当进程为explorer-exe时"><a href="#当进程为explorer-exe时" class="headerlink" title="当进程为explorer.exe时"></a>当进程为explorer.exe时</h3><p>获取到路径”C:\Users\sam\AppData\Roaming\Microsoft\Office\Recent”，然后进行死循环</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg7z0emq4j30no03iq30.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg7z0emq4j30no03iq30.jpg" class="lazyload"></a></p>
<p>从路径中拼出C:\Users\sam\AppData\Roaming\Microsoft\Office\Recent*.doc.lnk，文件夹中保存着最近打开过的Word文档的.lnk快捷方式</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg85roaepj30ia0e33zv.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg85roaepj30ia0e33zv.jpg" class="lazyload"></a></p>
<p>从.lnk快捷方式得出指向的原文件</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8v6dartj30gb0bu0tg.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8v6dartj30gb0bu0tg.jpg" class="lazyload"></a></p>
<p>拼接出路径”C:\Users\sam\AppData\Roaming\Microsoft\UserSetting\MediaCache”后创建这个文件夹，然后将文件夹设置为隐藏</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8gpmdb8j30np06aaaj.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8gpmdb8j30np06aaaj.jpg" class="lazyload"></a></p>
<p>硬编码Doc文件的文件头标志，判断文档后缀为.doc还是.docx，读取文档，与硬编码的标志头比较前21字节，确认是否为文档</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8wns5t5j30dt02ra9w.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8wns5t5j30dt02ra9w.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8wzb35mj30hs042wek.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfg8wzb35mj30hs042wek.jpg" class="lazyload"></a></p>
<p>拼接出路径C:\Users\sam\AppData\Roaming\Microsoft\UserSetting\NetworkDiagnos，在这个文件夹下创建一个生成的随机字符串.dat文件</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfga4kogn2j30ur0b3aal.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfga4kogn2j30ur0b3aal.jpg" class="lazyload"></a></p>
<p>向其中写入将读取到的doc文件加密后的十六进制数据</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfga5nm9okj30ex066jrm.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfga5nm9okj30ex066jrm.jpg" class="lazyload"></a></p>
<p>将读取到的doc文件拷贝到%APPDATA%\Microsoft\Word\123.docx</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgafehk1cj30sq02yq2w.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgafehk1cj30sq02yq2w.jpg" class="lazyload"></a></p>
<p>创建文件夹%APPDATA%\Microsoft\Word，在文件夹内创建一个vbs文件，写入内容</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgavj54mrj30it04xjrm.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgavj54mrj30it04xjrm.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgawgz70nj30tx0hxgoj.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgawgz70nj30tx0hxgoj.jpg" class="lazyload"></a></p>
<p>调用Wscript.exe执行VBS，CommandLine:</p>
<p>C:\Windows\System32\wscript.exe  C:\Users\sam\AppData\Roaming\Microsoft\Word\winword.vbs  C:\Users\sam\AppData\Roaming\Microsoft\Word.</p>
<p>用于将doc文档转换为txt文本</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgak7u13uj30eo09ygmd.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgak7u13uj30eo09ygmd.jpg" class="lazyload"></a></p>
<p>然后删除vbs文件，并将C:\Users\sam\AppData\Roaming\Microsoft\Word下转换出的txt文件移动到隐藏文件夹C:\Users\sam\AppData\Roaming\Microsoft\UserSetting\MediaCache中</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgbdgbxxlj30f501fq2r.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgbdgbxxlj30f501fq2r.jpg" class="lazyload"></a></p>
<h3 id="当进程为msdtc-exe时"><a href="#当进程为msdtc-exe时" class="headerlink" title="当进程为msdtc.exe时"></a>当进程为msdtc.exe时</h3><p>msdtc.exe是服务MSDTC的程序，对应前面劫持MSDTC服务</p>
<p>Dll跟随服务开机自启，然后找到Dropper的备份C:\Windows\System32\wimsvc.exe执行，实现Dropper的开机自启</p>
<p><a href="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1591259228414.png" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1591259228414.png" class="lazyload"></a></p>
<h3 id="当进程为HTON-exe、BON-exe、Cover-exe时"><a href="#当进程为HTON-exe、BON-exe、Cover-exe时" class="headerlink" title="当进程为HTON.exe、BON.exe、Cover.exe时"></a>当进程为HTON.exe、BON.exe、Cover.exe时</h3><p>创建文件夹C:\Users\sam\AppData\Roaming\Microsoft\UserSetting\BjDJTPvUnpqrxxKx9OXL</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgceq868fj30jd057aa3.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgceq868fj30jd057aa3.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgcgck2efj306i02aa9w.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgcgck2efj306i02aa9w.jpg" class="lazyload"></a></p>
<p>调用前面释放的Sharp.exe，Sharp.exe是WINRAR的程序，将Recent目录下的所有文件打包，密码PleaseTTakeOut6031416!!@@##</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgcjrtxrgj30lt08l0t3.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgcjrtxrgj30lt08l0t3.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgd3p4weqj30ke0fatc4.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgd3p4weqj30ke0fatc4.jpg" class="lazyload"></a></p>
<p>遍历”C:\Users\sam\AppData\Roaming\Microsoft\UserSetting”将前面得到的doc转txt文件复制到C:\Users\sam\AppData\Roaming\Microsoft\UserSetting\BjDJTPvUnpqrx0012CF68xKx9OXL下</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgd8mijcjj30yq06ldg6.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgd8mijcjj30yq06ldg6.jpg" class="lazyload"></a></p>
<p>将所有txt、刚才打包后的recent文件夹内内容和日志文件复制后打包到上级目录，密码为PleaseTakeOut6031416!!@@##，打包后调用CMD删除整个文件夹</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdd1g6xrj30kl0aagm0.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdd1g6xrj30kl0aagm0.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdh9y432j30k4079gn6.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdh9y432j30k4079gn6.jpg" class="lazyload"></a></p>
<p>将rar数据读取到内存，删除压缩包，然后对压缩包进行加密</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdnzapucj30ot035aa7.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdnzapucj30ot035aa7.jpg" class="lazyload"></a></p>
<p>加密前</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdofp0j8j30fe06c0sz.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdofp0j8j30fe06c0sz.jpg" class="lazyload"></a></p>
<p>加密后</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdovjausj30f606fjrn.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdovjausj30f606fjrn.jpg" class="lazyload"></a></p>
<p>HOOK函数WriteFile</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfge04jgflj30n602fwek.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfge04jgflj30n602fwek.jpg" class="lazyload"></a></p>
<p>正常的WriteFile</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdsk97tsj30eu06pt8y.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdsk97tsj30eu06pt8y.jpg" class="lazyload"></a></p>
<p>被HOOK后的WriteFile,jmp到了病毒代码</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdycm4jrj30gr04njri.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdycm4jrj30gr04njri.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdytp6jvj30a901f0si.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgdytp6jvj30a901f0si.jpg" class="lazyload"></a></p>
<p>HOOK后的代码对Word文档写入隐藏数据</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfge8bbhs6j30ll09jdgn.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfge8bbhs6j30ll09jdgn.jpg" class="lazyload"></a></p>
<p>创建死循环线程，保持窃密和日志更新</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgeagjagtj30fn04o3ym.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfgeagjagtj30fn04o3ym.jpg" class="lazyload"></a></p>
<p>导出表中有函数AccessDebugTracer和AccessRetailTracer</p>
<p>遍历进程目录查找到进程”explorer.exe”，远线程注入将自身注入到”explorer.exe”中</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfh52t87tyj30lb07oq39.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfh52t87tyj30lb07oq39.jpg" class="lazyload"></a></p>
<p>窃密</p>
<p>调用CMD执行大量拼接出的数据，获取网络相关信息，将相关内容加密后写入文件夹Media下计算机名-时间.rtt文件中</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfh5nngws9j30e30ejgn2.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfh5nngws9j30e30ejgn2.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfh5pjslu6j30my089my2.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfh5pjslu6j30my089my2.jpg" class="lazyload"></a></p>
<p>窃取获取IE临时文件</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdpr82luj30r202mwej.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdpr82luj30r202mwej.jpg" class="lazyload"></a></p>
<p>通过判断doc文档被感染后的特有标志，执行不同的内容</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdhx94ipj30lm0amq3r.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdhx94ipj30lm0amq3r.jpg" class="lazyload"></a></p>
<p>如果没有特有的标记，则判断word的创建或访问时间在一个月内，对word文档进行感染，将前面打包得到的加密后的RAR的十六进制数据添加在word文档尾部</p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdln2kvkj30ik095q3h.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdln2kvkj30ik095q3h.jpg" class="lazyload"></a></p>
<p><a href="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdm64zxcj30qr03kaa5.jpg" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gfhdm64zxcj30qr03kaa5.jpg" class="lazyload"></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>样本通过感染内网中的exe程序，进而感染word文档，随着Word文档由U盘带入隔离网，感染隔离网的文件并在隔离网内持久化，搜集情报，打包成加密的rar文件，并将rar文档二次加密后附加在word文档尾部，再跟随word文档由U盘带出隔离网，病毒判断每一次Word文档附加的指令，执行不同的代码。并使用自定义的文件传输协议而不是传统的网络协议。</p>
<p>基于自定义的文件传输控制指令完整过程：</p>
<p>​        攻击者当前位置可能是位于目标内网，能控制一定数量的机器和共享目录上的文件。</p>
<p>​        步骤1. 感染正常的EXE文件，通过受害者携带进入隔离网络的机器中执行。</p>
<p>​        步骤2. 被攻陷的隔离网络机器中的窃密数据，被附加到正常Word文档的末尾；</p>
<p>​        1) 附加窃密数据的Word文档被受害者携带撤出隔离网络；</p>
<p>​        2) 攻击者找到这些Word 文档，读取附加的窃密数据；</p>
<p>​        步骤3. 攻击者感染新的Word文档，附加命令和执行对象。</p>
<p>​        1) Word文档被受害者携带进入隔离网络；</p>
<p>​        2) 附加的命令和执行对象在隔离网络中已被攻陷的机器中得到执行；</p>
<p>​        3) 执行结果的日志随着步骤2也被带出隔离网络。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Yenn_</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://0xdf1001f.github.io/2020/06/06/Ramsay/">https://0xdf1001f.github.io/2020/06/06/Ramsay/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://0xdf1001f.github.io">Wei's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/">恶意软件    </a></div><div class="post_share"><div class="social-share" data-image="http://ww1.sinaimg.cn/large/006o5z8lgy1gcutqxg6juj309w03x0st.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/09/19/HW%E4%B8%AD%E7%9A%84%E4%B8%80%E6%9E%9ACS%E9%A9%AC/"><img class="prev_cover lazyload" data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106193001.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>HW中的一枚CS马</span></div></a></div><div class="next-post pull_right"><a href="/2020/06/06/e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0/"><img class="next_cover lazyload" data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gcutqxg6juj309w03x0st.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/09/19/HW中的一枚CS马/" title="HW中的一枚CS马"><img class="relatedPosts_cover lazyload"data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201106193001.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-09-19</div><div class="relatedPosts_title">HW中的一枚CS马</div></div></a></div><div class="relatedPosts_item"><a href="/2020/11/12/Turla-Kazuar-Backdoor/" title="Turla 样本分析"><img class="relatedPosts_cover lazyload"data-src="https://blog-1251128945.cos.ap-beijing.myqcloud.com/20201112113025.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-11-12</div><div class="relatedPosts_title">Turla 样本分析</div></div></a></div><div class="relatedPosts_item"><a href="/2020/06/06/e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0/" title="e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0"><img class="relatedPosts_cover lazyload"data-src="http://ww1.sinaimg.cn/large/006o5z8lgy1gcutqxg6juj309w03x0st.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-06</div><div class="relatedPosts_title">e5799d14e6ecfefb727bf22c8b9f36a8621655454a6480f3dd94812250bec9d0</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/24/xls宏病毒，程序不落地创建傀儡进程实现远控/" title="xls宏病毒，程序不落地创建傀儡进程实现远控"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/0xdf1001f/cdn@master/rrat.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-24</div><div class="relatedPosts_title">xls宏病毒，程序不落地创建傀儡进程实现远控</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/19/低能勒索病毒/" title="低能勒索病毒"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/0xdf1001f/cdn@master/E.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-19</div><div class="relatedPosts_title">低能勒索病毒</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/20/利用系统文件执行的远控/" title="利用系统文件执行的远控"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/0xdf1001f/cdn@master/rat.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-20</div><div class="relatedPosts_title">利用系统文件执行的远控</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'4iHpByXHTO1Rz8Jp7z1nJ211-gzGzoHsz',
  appKey:'dR4gLrc51geG7WX58ESN7dmJ',
  placeholder:'留个言再走⑧',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Yenn_</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">阿炜's Blog</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/ClickShowText.js"></script></body></html>